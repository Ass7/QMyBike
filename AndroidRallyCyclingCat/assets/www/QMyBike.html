<html>
<head>
<script src="js/jquery-1.10.1.min.js"></script>
<!--  needed for this sample, not for qeo itself -->
<script src="js/qeo.js"></script>
<!-- Load the manifest for this sample -->
<script src="js/QMyBike_CheckPoint.js"></script>
<!-- Load qeo types. Generated by qeo-codegen. -->
<script src="js/QeoManifest-QMyBike.js"></script>
<script src="js/QSimpleChat_ChatMessage.js"></script>

<!-- Load the manifest for this sample -->


<script type="text/javascript">
	//----------------------------------
	// Wait until document is ready
	//----------------------------------
	var selectedUserId = -1;
	var policyList;
	var writer;
	$(document)
			.ready(
					function() {

						var factoryOptions = {
							"manifest" : com_astebbot_rally_cycling_Cat_Manifest
						};

						// 						var factoryOptions = {
						// 							"manifest" : org_qeo_sample_simplechat_ChatMessage_Manifest
						// 						};

						Qeo
								.createFactory(factoryOptions)
								.then(
										function(factory) {
											//make sure to pass enablepolicy: true to the creation of needed readers/writers
											var promisedCPWriter = factory
													.createEventWriter(
															"org::qeo::sample::simplechat::ChatMessage",
															{
																"enablePolicy" : true
															});
											var promisedCPReader = factory
													.createEventReader("org::qeo::sample::simplechat::ChatMessage");

											// create a Qeo factory. Pass the manifest file as an
											// option.
											// 	Qeo.createFactory(factoryOptions1).then(
											// 		function(factory) {
											// 			// creation of the factory is
											// 			// asynchronous. This
											// 			// function will be
											// 			// called when the factory is created.
											// 			// factory created!

											// 			// now create the readers and writer.
											// 			// this also is asynchronous and will
											// 			// return a
											// 			// promise.

											// 			// CP

											// 			var promisedCPWriter = factory
											// 					.createEventWriter("com::bemybikerally::bike::CheckPoint");
											// 			var promisedCPReader = factory
											// 					.createEventReader("com::bemybikerally::bike::CheckPoint");

											return promisedCPWriter
													.then(function(_writer) {
														writer = _writer;
														return promisedCPReader
																.then(function(
																		_reader) {
																	reader = _reader;
																});
													})
										})
								.then(
										function() {

											// writer is
											// created.
											console
													.log('CP writer is created.');
											$("#send")
													.click(
															function() {
																// add
																// hook
																// to
																// the
																// send
																// button.
																var data = {
																	// 														'checkPointId' : $(
																	'from' : $(
																			'#checkPointId')
																			.val(),
																	// 														'enigma' : $(
																	'message' : $(
																			'#enigma')
																			.val()
																};
																writer
																		.write(data);
															});
											reader
													.on(
															"data",
															function(data) {
																// handle
																// read
																// events.
																$('#output')
																		.append(
																				'<div class="message"><span class="username">'
																						// 																											+ data.checkPointId
																						+ data.from
																						+ '</span><span class="messagetext">'
																						// 																											+ data.enigma
																						+ data.message
																						+ '</span></div>');
																$('#output')
																		.scrollTop(
																				$(
																						'#output')
																						.get(
																								0).scrollHeight);
															});

											function addUser(id, name) {
												$('#privateUserId')
														.append(
																'<option value="'
																		+ id
																		+ '"'
																		+ (id == selectedUserId ? " selected=\"selected\""
																				: "")
																		+ '>'
																		+ name
																		+ '</option>');
											}

											writer
													.on(
															"policyUpdate",
															function(data) {
																//this callback will be called whenever a policy update is requested or detected by the Qeo system.
																//update the user list to who messages can be send to.
																policyList = data;
																$(
																		'#privateUserId')
																		.empty();
																addUser(-1,
																		"All");
																for (var index = 0; index < data.users.length; ++index) {
																	var user = data.users[index];
																	addUser(
																			user.id,
																			user.id); //not possible to get a username yet
																}
															});
											//request a policyupdate to get a list of users.
											writer.requestPolicy();
										}, function(error) {
											//error in factory creation.
											console.error(error);
											alert(error);
										});

					});
	//----------------------------------
	// Reload document => cleanup
	//----------------------------------
	window.addEventListener('unload', function() {
		Qeo.cleanup();
	});

	//This function will get called when a new private user is selected to send the message to.
	//If "all" is selected, all users will get allow:true
	//If a specifi user is selected, all users will get allow:false, except for the selected one.
	function setNewPolicy() {
		selectedUserId = $('#privateUserId option:selected').val();
		for (var index = 0; index < policyList.users.length; ++index) {
			policyList.users[index].allow = (selectedUserId == -1
					|| policyList.users[index].id == selectedUserId ? true
					: false);
		}
		//send the new policy to Qeo
		writer.updatePolicy(policyList);
	}
</script>

<style>
.username {
	color: red;
	font-weight: bold;
}

.messagetext {
	color: white;
}

.message {
	border: solid 1px black;
}

span {
	display: inline-block;
	*display: inline; /* for IE7*/
	*zoom: 1; /* for IE7*/
	width: auto !important; width 150px;
	min-width: 150px;
}

body {
color:white;
/* background-color:white; */
background-image:url(img/fond.png);
background-size: 100%;
}

</style>

<title>Hello World</title>
</head>
<body>
	<div id="input" style="clear: both;">
		CheckPoint # <input id="checkPointId" type="text" value="0000001" />
		<br /> Enigma <input id="enigma" type="text" style="width: 80%;" />
		<br />
		<hr />
		Development : <br /> Stamp only Manifest From <select
			id="privateUserId" onchange="setNewPolicy()"></select>
		<hr />
		<button id="send">Stamp!</button>
	</div>
	<hr />
	<div id="output"
		style="border: solid black; padding: 10px; overflow-y: auto; margin: 0px; margin-bottom: 5px; height: 60%;">
		<div class="message">
			<span class="username">CheckPoint</span><span class="messagetext">Enigma</span>
		</div>
	</div>
</body>
</html>

